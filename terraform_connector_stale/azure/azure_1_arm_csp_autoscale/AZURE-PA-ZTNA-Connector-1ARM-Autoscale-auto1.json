{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "vmName": {
      "type": "string",
      "defaultValue": "ztna-connector-1arm",
      "metadata": {
        "description": "VM Name of the Prisma Access ZTNA Connector."
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Virtual Network (VNET)"
      },
      "defaultValue": "CGNXVNET"
    },
    "vnetNewOrExisting": {
      "type": "string",
      "defaultValue": "new",
      "allowedValues": [
        "new",
        "existing"
      ],
      "metadata": {
        "description": "Use new or existing VNET"
      }
    },
    "virtualNetworkAddressPrefixes": {
      "type": "array",
      "defaultValue": [
        "10.5.0.0/16"
      ],
      "metadata": {
        "description": "Virtual network address CIDR"
      }
    },
    "virtualNetworkExistingRGName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of resource group of existing VNET (if applicable)"
      }
    },
    "subnet1Name": {
      "type": "string",
      "defaultValue": "Internet",
      "metadata": {
        "description": "Subnet for Internet/Public Port"
      }
    },
    "subnet1Prefix": {
      "type": "string",
      "defaultValue": "10.5.1.0/24",
      "metadata": {
        "description": "Internet/Public subnet CIDR"
      }
    },
    "bootstrap": {
      "type": "string",
      "defaultValue": "yes",
      "allowedValues": [
        "yes"
      ],
      "metadata": {
        "description": "Pass bootstrap data to VM"
      }
    },
    "licenseKey": {
      "type": "string",
      "metadata": {
        "description": "Prisma Access ZTNA Connector vION License Key"
      }
    },
    "licenseSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Prisma Access ZTNA Connector vION License Secret"
      }
    },
    "scaleSetName": {
      "defaultValue": "ztna-connector-1arm-autoscalset",
      "type": "String"
    },
    "maxInstanceCount": {
      "type": "int",
      "defaultValue": 4,
      "maxValue": 4,
      "minValue": 1,
      "metadata": {
        "description": "Number of VM instances (4 or less)."
      }
    },
    "ScaleOutMetricMbps": {
      "type": "int",
      "defaultValue": 700,
      "maxValue": 1000,
      "minValue": 100,
      "metadata": {
        "description": "Scale Out Metric in Mbps (100 Mbps to 1000 Mbps)."
      }
    },
    "ScaleInMetricMbps": {
      "type": "int",
      "defaultValue": 200,
      "maxValue": 500,
      "minValue": 1,
      "metadata": {
        "description": "Scale In Metric in Mbps (1 Mbps to 500 Mbps)."
      }
    },
    "adminUserName": {
      "type": "string",
      "defaultValue": "adminuser"
    },
    "host1_ip": {
      "defaultValue": "44.239.132.397",
      "type": "string"
    },
    "host2_ip": {
      "defaultValue": "44.239.132.397",
      "type": "string"
    },
    "host3_ip": {
      "defaultValue": "44.239.132.397",
      "type": "string"
    },
    "host4_ip": {
      "defaultValue": "44.239.132.397",
      "type": "string"
    },
    "host2_name": {
      "defaultValue": "vmfg-auto1.hood.cgnx.net",
      "type": "string"
    },
    "host3_name": {
      "defaultValue": "controller-auto1.hood.cgnx.net",
      "type": "string"
    },
    "host4_name": {
      "defaultValue": "toolkitsessions-auto1.hood.cgnx.net",
      "type": "string"
    }
  },
  "variables": {
    "imageVersion": "latest",
    "imagePublisher": "paloaltonetworks",
    "imageSku": "pan-prisma-access-ztna-connector",
    "imageOffer": "pan-prisma-access-ztna-connector",
    "vmName": "[parameters('vmName')]",
    "nicName": "[concat(variables('vmName'), '-eth')]",
    "existingVnetID": "[resourceId(parameters('virtualNetworkExistingRGName'),concat('Microsoft.Network','/','virtualNetworks'),parameters('virtualNetworkName'))]",
    "existingSubnet1Ref": "[concat(variables('existingVnetID'),'/subnets/',parameters('subnet1Name'))]",
    "newVnetID": "[resourceId('Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
    "newSubnet1Ref": "[concat(variables('newVnetID'),'/subnets/',parameters('subnet1Name'))]",
    "subnet1Ref": "[if(equals(parameters('vnetNewOrExisting'),'new'), variables('newSubnet1Ref'), variables('existingSubnet1Ref'))]",
    "virtualNetworkAddressPrefix": "[parameters('virtualNetworkAddressPrefixes')[0]]",
    "customData": "[base64(concat('[General]\nmodel = ion 200v\nhost1_name = locator.cgnx.net\nhost1_ip = ',parameters('host1_ip'),'\nhost2_name = ',parameters('host2_name'),'\nhost2_ip = ',parameters('host2_ip'),'\nhost3_name = ',parameters('host3_name'),'\nhost3_ip = ',parameters('host3_ip'),'\nhost4_name = ',parameters('host4_name'),'\nhost4_ip = ',parameters('host4_ip'),'\n\n[License]\nkey = ',parameters('licenseKey'),'\nsecret = ',parameters('licenseSecret'),'\n\n[1]\nrole = PublicWAN\ntype = DHCP\n\n'))]",
    "adminPass": "to_GET_VION_Installed_never_Used",
    "nic1": "[concat(variables('nicName'), '1')]",
    "subnets": [
      {
        "name": "[parameters('subnet1Name')]",
        "properties": {
          "addressPrefix": "[parameters('subnet1Prefix')]"
        }
      }
    ],
    "scaleSetName": "[parameters('scaleSetName')]",
    "autoscaleName": "[concat(variables('scaleSetName'),'autoscale')]"
  },
  "resources": [
    {
      "name": "[parameters('virtualNetworkName')]",
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2022-07-01",
      "condition": "[equals(parameters('vnetNewOrExisting'), 'new')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('virtualNetworkAddressPrefix')]"
          ]
        },
        "subnets": "[variables('subnets')]"
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "apiVersion": "2022-11-01",
      "name": "[parameters('scaleSetName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
      ],
      "sku": {
        "name": "Standard_D4s_v3",
        "tier": "Standard",
        "capacity": 1
      },
      "plan": {
        "name": "[variables('imageSku')]",
        "product": "[variables('imageOffer')]",
        "publisher": "[variables('imagePublisher')]"
      },
      "properties": {
        "singlePlacementGroup": "false",
        "orchestrationMode": "Uniform",
        "upgradePolicy": {
          "mode": "Automatic"
        },
        "virtualMachineProfile": {
          "osProfile": {
            "computerNamePrefix": "[variables('vmName')]",
            "adminUsername": "[parameters('adminUserName')]",
            "adminPassword": "[variables('adminPass')]",
            "linuxConfiguration": {
              "disablePasswordAuthentication": false
            },
            "customData": "[if(equals(parameters('bootstrap'), 'no'), json('null'), variables('customData'))]"
          },
          "storageProfile": {
            "imageReference": {
              "publisher": "[variables('imagePublisher')]",
              "offer": "[variables('imageOffer')]",
              "sku": "[variables('imageSku')]",
              "version": "[variables('imageVersion')]"
            },
            "osDisk": {
              "createOption": "FromImage"
            }
          },
          "networkProfile": {
            "networkInterfaceConfigurations": [
              {
                "name": "[variables('nic1')]",
                "properties": {
                  "primary": true,
                  "ipConfigurations": [
                    {
                      "name": "ipconfig-untrust",
                      "properties": {
                        "subnet": {
                          "id": "[variables('subnet1Ref')]"
                        }
                      }
                    }
                  ]
                }
              }
            ]
          },
          "diagnosticsProfile": {
            "bootDiagnostics": {
              "enabled": true
            }
          },
          "scheduledEventsProfile": {
            "terminateNotificationProfile": {
              "notBeforeTimeout": "PT15M",
              "enable": true
            }
          }
        },
        "overprovision": false,
        "doNotRunExtensionsOnOverprovisionedVMs": false,
        "platformFaultDomainCount": 1
      }
    },
    {
      "type": "microsoft.insights/autoscalesettings",
      "apiVersion": "2022-10-01",
      "name": "[variables('autoscaleName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('scaleSetName'))]"
      ],
      "properties": {
        "name": "[variables('autoscaleName')]",
        "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('scaleSetName'))]",
        "enabled": true,
        "profiles": [
          {
            "name": "ztna_auto_scale",
            "capacity": {
              "minimum": "1",
              "maximum": "[parameters('maxInstanceCount')]",
              "default": "1"
            },
            "rules": [
              {
                "metricTrigger": {
                  "metricName": "Network In Total",
                  "metricNamespace": "microsoft.compute/virtualmachinescalesets",
                  "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('scaleSetName'))]",
                  "timeGrain": "PT1M",
                  "statistic": "Average",
                  "timeWindow": "PT5M",
                  "timeAggregation": "Average",
                  "operator": "GreaterThan",
                  "threshold": "[mul(parameters('ScaleOutMetricMbps'),7500000)]",
                  "dividePerInstance": false
                },
                "scaleAction": {
                  "direction": "Increase",
                  "type": "ChangeCount",
                  "value": "1",
                  "cooldown": "PT40M"
                }
              },
              {
                "metricTrigger": {
                  "metricName": "Network In Total",
                  "metricNamespace": "microsoft.compute/virtualmachinescalesets",
                  "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('scaleSetName'))]",
                  "timeGrain": "PT1M",
                  "statistic": "Average",
                  "timeWindow": "PT5M",
                  "timeAggregation": "Average",
                  "operator": "LessThan",
                  "threshold": "[mul(parameters('ScaleInMetricMbps'),7500000)]",
                  "dividePerInstance": false
                },
                "scaleAction": {
                  "direction": "Decrease",
                  "type": "ChangeCount",
                  "value": "1",
                  "cooldown": "PT45M"
                }
              }
            ]
          }
        ]
      }
    }
  ]
}